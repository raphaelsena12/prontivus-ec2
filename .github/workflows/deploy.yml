name: Deploy para EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permite execução manual

jobs:
  deploy:
    name: Deploy na EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Copiar script de deploy para EC2
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            infrastructure/scripts/deploy.sh \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/deploy.sh

      - name: Copiar ecosystem.config.js para EC2
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            infrastructure/ecosystem.config.js \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/opt/prontivus/ecosystem.config.js

      - name: Executar deploy na EC2
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            # Criar diretório da aplicação se não existir
            sudo mkdir -p /opt/prontivus
            sudo mkdir -p /opt/prontivus/logs
            
            # Verificar se é um repositório Git
            if [ ! -d /opt/prontivus/.git ]; then
              echo "⚠️ Aviso: Diretório não é um repositório Git. Execute manualmente:"
              echo "  cd /opt/prontivus && sudo git clone <repo-url> . && sudo chown -R ubuntu:ubuntu /opt/prontivus"
            fi
            
            # Tornar script executável
            chmod +x /tmp/deploy.sh
            
            # Executar script de deploy
            /tmp/deploy.sh
            
            # Limpar script temporário
            rm -f /tmp/deploy.sh
          EOF

      - name: Verificar status da aplicação
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "Status do PM2:"
            pm2 status
            
            echo ""
            echo "Últimas linhas de log:"
            pm2 logs prontivus --lines 20 --nostream || true
          EOF

      - name: Health Check
        run: |
          sleep 10
          if curl -f http://${{ secrets.EC2_HOST }}:3000 > /dev/null 2>&1; then
            echo "✅ Aplicação está respondendo"
          else
            echo "⚠️ Aplicação pode não estar respondendo ainda"
            exit 0  # Não falhar o workflow, apenas avisar
          fi

      - name: Limpar chaves SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f ~/.ssh/known_hosts
