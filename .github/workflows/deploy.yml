name: Deploy para EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permite execução manual

jobs:
  deploy:
    name: Deploy na EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          
          # Verificar se a chave foi salva corretamente (sem mostrar o conteúdo)
          echo "Verificando chave SSH..."
          if [ -f ~/.ssh/deploy_key ]; then
            KEY_LINES=$(wc -l < ~/.ssh/deploy_key)
            echo "✅ Chave salva com $KEY_LINES linhas"
            echo "Primeira linha: $(head -1 ~/.ssh/deploy_key)"
            echo "Última linha: $(tail -1 ~/.ssh/deploy_key)"
          else
            echo "❌ Erro: Chave não foi salva"
            exit 1
          fi
          
          # Testar conexão com debug
          echo "Testando conexão SSH..."
          ssh -v -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o IdentitiesOnly=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "echo 'Conexão SSH funcionando!'" || echo "⚠️ Teste de conexão falhou, mas continuando..."

      - name: Copiar script de deploy para EC2
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o IdentitiesOnly=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -v \
            infrastructure/scripts/deploy.sh \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/deploy.sh

      - name: Executar deploy na EC2
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o IdentitiesOnly=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            
            # Diretório da aplicação
            APP_DIR="/opt/prontivus"
            cd "$APP_DIR" || exit 1
            
            # Verificar se é um repositório Git
            if [ ! -d .git ]; then
              echo "❌ Erro: Diretório não é um repositório Git"
              exit 1
            fi
            
            # Tornar script executável
            chmod +x /tmp/deploy.sh
            
            # Executar script de deploy
            /tmp/deploy.sh
            
            # Limpar script temporário
            rm -f /tmp/deploy.sh
          EOF

      - name: Verificar status da aplicação
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o IdentitiesOnly=yes \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "=== Status do PM2 ==="
            pm2 status
            
            echo ""
            echo "=== Últimas linhas de log ==="
            pm2 logs prontivus --lines 20 --nostream || true
          EOF

      - name: Health Check
        run: |
          sleep 10
          # Testar via HTTPS (domínio)
          if curl -f https://prontivus.com > /dev/null 2>&1; then
            echo "✅ Aplicação está respondendo via HTTPS"
          elif curl -f http://${{ secrets.EC2_HOST }}:3000 > /dev/null 2>&1; then
            echo "✅ Aplicação está respondendo via HTTP"
          else
            echo "⚠️ Aplicação pode não estar respondendo ainda"
            exit 0  # Não falhar o workflow, apenas avisar
          fi

      - name: Limpar chaves SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f ~/.ssh/known_hosts
